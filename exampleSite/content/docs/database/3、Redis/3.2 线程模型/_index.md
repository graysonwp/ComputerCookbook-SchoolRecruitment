---
weight: 12
---

# 线程模型

## 1 什么是 Redis 事件

1. Redis 服务器是一个**事件驱动程序**，服务器需要处理以下两类事件：
2. **文件事件**：
   
   1. Redis 服务器**通过套接字与客户端**（或者其他 Redis 服务器）**进行连接**，而**文件事件就是服务器对套接字操作的抽象**。
   2. **服务器与客户端**（或者其他服务器）**的通信会产生相应的文件事件**，而**服务器就是通过监听并处理这些事件来完成一系列网络通信操作**。
3. **时间事件**：
   
   1. Redis 服务器中的**一些操作**（比如 `serverCron` 函数）**需要在给定的时间点运行**，而**时间事件就是服务器对这类定时操作的抽象**。

## 2 事件分类

Redis 中的事件可以分为两类，分别是**文件事件**和**时间事件**。

### 2.1 文件事件

#### 2.1.1 含义

1. Redis**基于 `Reactor` 模式开发了自己的网络事件处理器**，这个处理器被称为**文件时间处理器**。
2. **文件事件处理器使用 I/O 多路复用程序来同时监听多个套接字**，并**根据套接字目前执行的任务来为套接字关联不同的事件处理器**。
3. 当**被监听的套接字准备好执行连接应答**、**读取**、**写入**、**关闭等操作时**，**与操作相对应的文件事件就会产生**，这时**文件处理器就会调用套接字之前关联好的事件处理器来处理这些事件**。
4. 虽然**文件处理器以单线程方式运行**，但**通过使用 I/O 多路复用程序来监听多个套接字**，文件处理器**既实现了高性能的网络通信模型**，**又很好地与 Redis 服务器中其他同样以单线程方式运行的模块进行对接**，这**保持了 Redis 内部单线程设计的简单性**。

#### 2.1.2 文件事件处理器

文件事件处理器主要由四个部分组成，分别是**套接字**、**I/O 多路复用程序**、**文件事件分派器**、**事件处理器**。

![](../../../media/202107/2021-07-15_163515.png)

1. **套接字**：
   1. **文件事件是对套接字操作的抽象**，**每当一个套接字准备好执行连接应答**、**写入**、**读取**、**关闭等操作时**，就**会产生一个文件事件**，因为**一个服务器通常会连接多个套接字**，所以**多个文件事件可能会并发地出现**。
2. **I/O 多路复用程序**：
   1. **I/O 多路复用程序负责监听多个套接字**，并**向文件事件分派器传送那些产生了事件的套接字**。
   2. 尽管**多个文件事件可能会并发地出现**，但**I/O 多路复用程序总是会将所有产生事件的套接字放到一个队列里面**，然后**通过这个队列**，**以有序**、**同步**、**每次一个套接字的方式向文件事件分派器传送套接字**，**当上一个套接字产生的事件被处理完毕之后**，**I/O 多路复用程序才会继续向文件事件分派器传送下一个套接字**。
      
      ![](../../../media/202107/2021-07-15_164350.png)
3. **文件事件分派器**：
   1. 文件事件分派器**接收 I/O 多路复用程序传来的套接字**，并**根据套接字产生的事件的类型**，**调用相应的事件处理器**。
4. **事件处理器**：
   1. **服务器会为执行不同任务的套接字关联不同的事件处理器**，**这些处理器是一个个函数**，他们**定义了某个事件发生时**，**服务器应该执行怎样的动作**。
   2. Redis 为文件事件编写了多个处理器，这些事件处理器分别用于实现不同的网络通信需求：
      1. 为了**对连接服务器的各个客户端进行应答**，服务器要监听套接字关联**连接应答处理器**。
      2. 为了**接收客户端传来的命令请求**，服务器要为客户端套接字关联**命令请求处理器**。
      3. 为了**向客户端返回命令的执行结果**，服务器要为客户端套接字关联**命令回复处理器**。
      4. 当**主服务器和从服务器进行复制操作**时，主从服务器都需要关联特别为复制功能编写的**复制处理器**。
   3. 这些事件处理器里面，服务器最常用的有**连接应答处理器**、**命令请求处理器**和**命令回复处理器**。

> 套接字产生的事件类型有哪些？
> 
> 1. 套接字产生的事件类型有两种，分别是 `AS_READABLE` 事件和 `AS_WRITABLE` 事件：
>    1. 当**套接字变得可读**时（**客户端对套接字执行 `write` 操作**，**或者执行 `close` 操作**），或者**有新的可应答套接字出现时**（**客户端对服务器的监听套接字执行 `connect` 操作**），**套接字产生 `AE_READABLE` 事件**。
>    2. 当**套接字变得可写**时（**客户端对套接字执行 `read` 操作**），**套接字产生 `AE_WRITABLE` 事件**。
> 2. I/O 多路复用程序**允许同时监听套接字的 `AE_READABLE` 事件和 `AE_WRITABLE` 事件**，如果**一个套接字同时产生了这两种事件**，那么文件事件分派器会**优先处理 `AE_READABLE` 事件**，**等到 `AE_READABLE` 事件处理完之后**，**才处理 `AE_WRITABLE` 事件**。

#### 2.1.3 一次完整的客户端与服务器连接事件示例

1. 假设一个 Redis 服务器正在运作，那么这个服务器的**监听套接字的 `AE_READABLE` 事件应该正处于监听状态之下**，而**该事件所对应的处理器为连接应答处理器**。
2. 如果这时**有一个 Redis 客户端向服务器发起连接**，那么**监听套接字将产生 `AE_READABLE` 事件**，**触发连接应答处理器执行**，**处理器会对客户端的连接请求进行应答**，然后**创建客户端套接字**，**以及客户端状态**，**并将客户端套接字的 `AS_READABLE` 事件与命令请求处理器进行关联**，使得**客户端可以向主服务器发送命令请求**。
3. 之后，**假设客户端向主服务器发送一个命令请求**，那么**客户端套接字将产生 `AE_READABLE` 事件**，**引发命令请求处理器执行**，**处理器读取客户端的命令内容**，然后**传给相关程序去执行**。
4. **执行程序将产生相应的命令回复**，**为了将这些命令回复传送回客户端**，**服务器将客户端套接字的** `AE_WRITABLE`**事件与命令回复处理器进行关联**，当**客户端尝试读取命令回复的时候**，**客户端套接字将产生 `AE_WRITABLE` 事件**，**触发命令回复处理器执行**，当**命令回复处理器将命令回复全部写入到套接字之后**，服务器就会**解除客户端套接字的 `AE_WRITABLE` 事件与命令回复处理器之间的关联**。
   
   ![](../../../media/202107/2021-07-15_180437.png)

## 参考文献

1. [【面试题】技术面试题汇总 🔥](https://imageslr.com/2020/07/08/tech-interview.html)。
2. redis 设计与实现（第二版）。
3. [Redis 系列（六）：你说要看 Redis 线程模型？安排](https://xie.infoq.cn/article/b6733865dbf95ddcf9968156a)。
   

