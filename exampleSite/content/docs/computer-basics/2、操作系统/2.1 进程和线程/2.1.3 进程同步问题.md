---
weight: 3
---

# 进程同步问题

> 进程的**同步是目的**，而进程间**通信是**实现进程同步的**手段**。

## 1 管程

### [1]().1 含义

1. 管程**将共享变量以及对这些共享变量的操作封装起来**，形成一个**具有一定功能接口的功能模块**，这样**只能通过管程提供的某个过程才能访问管程中的资源**，使用完之后**必须释放管程并唤醒入口等待队列中的进程**。
2. 正在管程中的线程**可临时放弃管程的互斥访问**，**等待事件出现时恢复**。
3. 管程使用**锁**确保了**在任何情况下管程中只有一个活跃的线程**，即**确保线程互斥访问临界区**。
4. 管程使用**条件变量提供的等待队列**实现**线程间协作**，**当线程暂时不能获得所需资源时，进入队列等待，当线程可以获得所需资源时，从等待队列中唤醒**。

### 1.2 组成

管程主要有三部分组成，具体如下：

1. **一个锁：** 控制管程代码的互斥访问。
2. **入口队列：** 每次只能有一个线程进入。
3. **条件变量：** 管理数据的并发访问。

![](.../../../media/202105/2021-05-07_165256.png)

### 1.3 条件变量

1. 条件变量是**管程内的等待机制**。
2. 每个条件变量**表示一种等待原因**，**对应一个等待队列**。
3. 条件变量有两种操作：
   1. `wait()` 操作：
      * **将自己阻塞在队列中**。
      * **唤醒一个等待者**或者**释放管程的互斥访问**（即**允许另外一个线程进入管程**）。
   2. `signal()` 操作：
      1. **将等待队列中的一个线程唤醒**。
      2. 如果**等待队列为空**，这就相当于是一个**空操作**。

### 1.4 语义

事实上管程一共有三种语义：

1. **Hoare 语义**。
2. **Mesa 语义**。
3. **Hansen 语义**。

#### 1.4.1 Honare 语义

1. 当**一个进程试图进入管程时**，会**首先在入口队列等待**。
2. 如果**P 进程唤醒了 Q 进程**，则**Q 进程先执行**，**P 在紧急队列中等待**。
3. 执行**wait**操作的进程**进入条件变量链末尾**，**唤醒紧急等待队列或者入口队列中的进程**。
4. 执行**signal**操作时会**唤醒条件变量链中的进程**，**自己进入紧急等待队列**，若**条件变量链为空**，则**继续执行**。

#### 1.4.2 Mesa 语义

1. **将 Honare 中的 signal 换成了 notify**（或者**broadcast 通知所有满足条件的**），**进行通知而不是立马交换管程的所有权**。
2. 在合适的时候，**条件队列首位的进程可以进入**，但进入之前**必须用 while 检查条件是否合适**。

## 2 临界区的概念

临界区是指**各个进程中对临界资源进行操作的程序片段**。

> 临界资源是什么？
>
> 临界资源是指**互斥共享变量所代表的的资源**，即**一次只能被一个进程使用的资源**。

## 3 同步与互斥的概念

1. **同步：** 多个进程因为**合作**而使得**进程的执行有一定的先后顺序**，比如**某个进程需要另一个进程提供的消息**，**获得消息之前进入阻塞态**。
2. **互斥：** 多个进程在**同一个时刻只有一个进程能进入临界区**。

## 4 并发和并行的区别

1. **并发：** 一段时间里**运行多个程序或者是任务**，但并**不是同一时间运行多个程序或者是任务**，只是**这段时间里 CPU 分开安排了任务**，**不同的时间 CPU 执行不同的程序或任务**。
2. **并行：** 当系统有一个以上的 CPU 时，每个 CPU 执行一个任务，线程之间不抢占 CPU 的资源，可以同时进行。

> **多线程**是**并发执行**的一段代码，是实现异步的手段。

## 5 同步和异步的区别

1. **同步：** 发出一个功能调用，在**没有得到结果之前**，**该调用就不返回或继续执行后续操作**。
2. **异步：** 发出一个功能调用后，**不等待返回结果**，**直接开始后续的操作**，一般**通过状态、通知和回调来通知调用者**。

## 6 参考文献

1. [进程同步问题](https://github.com/wolverinn/Waking-Up/blob/master/Operating%20Systems.md#%E8%BF%9B%E7%A8%8B%E5%90%8C%E6%AD%A5%E9%97%AE%E9%A2%98)。
2. [《操作系统》第 18 讲：“信号量与管程”总结](https://zhanghuimeng.github.io/post/os-mooc-lecture-18-summary)。
3. [管程(Moniter) 并发编程的基本心法](https://juejin.cn/post/6844903942443401223)。
4. [Java 并发编程中的管程（Monitor）模型](https://zhuanlan.zhihu.com/p/85812140)。
5. [并发并行和同步异步的概念](https://blog.csdn.net/qq_40557223/article/details/104071985)。
