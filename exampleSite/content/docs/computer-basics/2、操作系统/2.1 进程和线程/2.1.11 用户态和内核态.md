---
weight: 11
---

# 用户态和内核态

## 1 什么是用户态和内核态

1. 为了**限制不同程序的访问能力**，**防止一些程序访问其他程序的内存数据**，CPU划分了用户态和内核态两个权限等级：
   1. **用户态**只能**受限地访问内存**，且**不允许访问外围设备**，**没有占用CPU的能力**，**CPU资源可以被其他程序获取**。
   2. **内核态可以访问内存所有数据以及外围设备**，**也可以进行程序的切换**。
2. **所有用户程序都运行在用户态**，但有时需要进行一些**内核态的操作**，比如**从硬盘或者键盘读数据**，这时就需要进行**系统调用**，**使用陷阱指令**，**CPU切换到内核态，执行相应的服务，再切换回用户态并返回系统调用的结果**。

## 2 为什么要区分用户态和内核态

1. 主要是为了区别执行**特权指令**和**非特权指令**。
2. 在CPU的所有指令中，有一些指令是非常危险的，如果错用，将导致整个系统崩溃，比如**清内存、设置时钟等**。
3. 所以，CPU将指令分为特权指令和非特权指令，对于那些**危险的指令**，**只允许操作系统及其相关模块使用**，**普通的应用程序只能使用那些不会造成灾难的指令**。

## 3 用户态和内核态之间如何切换

用户态和内核态之间的切换主要有三种方式，分别是**系统调用、中断、异常**。

### 3.1 系统调用

1. 这是**用户态进程主动要求切换到内核态**的一种方式，**用户态进程**通过**系统调用**申请**使用操作系统提供的服务程序完成工作**，比如`fork()`实际上就是执行了一个创建新进程的系统调用。
2. 而**系统调用**的机制其**核心**还是使用了操作系统为用户特别开放的一个**中断**来实现的。

### 3.2 中断

1. 当**外围设备完成用户请求操作**后，会**向CPU发出相应的中断信号**，这时**CPU会暂停执行下一条即将要执行的指令转而去执行与中断信号对应的处理程序**。
2. 如果**先前执行的指令是用户态下的程序**，那么这个转换的过程**自然也就发生了由用户态到内核态的切换**，比如**硬盘读写操作完成**，**系统会切换到硬盘读写的中断处理程序中执行后续操作**。

### 3.3 异常

1. 当CPU在**执行运行在用户态下的程序**时，**发生了某些事不可知的异常**，这时会**触发由当前运行进程切换到处理此异常的内核相关程序**中，也就**转到了内核态**，比如**缺页异常**。

## 参考文献

1. [什么是用户态和内核态？](https://github.com/wolverinn/Waking-Up/blob/master/Operating%20Systems.md#%E4%BB%80%E4%B9%88%E6%98%AF%E7%94%A8%E6%88%B7%E6%80%81%E5%92%8C%E5%86%85%E6%A0%B8%E6%80%81)
2. [用户态和核心态的概念以及为什么要区别？以及两者之间的切换](https://www.codenong.com/cs105695961)？
